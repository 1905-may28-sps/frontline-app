package com.revature.service;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.revature.beans.Post;
import com.revature.beans.PostRating;
import com.revature.beans.Rating;
import com.revature.beans.User;
import com.revature.repository.PostRatingRepository;
import com.revature.repository.PostRepository;

@Service
public class PostService {
	@Autowired
	PostRepository postRepo;
	
	 @Autowired
	    private PostRatingRepository postRatingRepo;
	
	public Post add(Post p) {
		return postRepo.save(p);
	}
	
	public List<Post> getAll(){
		return postRepo.findAll();
	}
	
	 public Post getPost(int id) {
	        return postRepo.findOne(id);
	    }
	
    public void vote(int postId, boolean like) throws AlreadyVotedException {
        User currentUser = UserService.currentUser();

        Post post = getPost(postId);

        PostRating rating = postRatingRepo.findUserRating(postId, currentUser.getUserId());

        if (rating != null) {
            throw new AlreadyVotedException("cannot vote more than once");
        }

        rating = new PostRating();

        rating.setUser(currentUser);
        rating.setValue(like ? Rating.LIKE_VALUE : Rating.DISLIKE_VALUE);
        rating.setPost(post);

        postRatingRepo.saveAndFlush(rating);
    }
}
